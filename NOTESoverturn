Notes on the overturning streamfuction in density space.

Two options:

Online:
Enable the layers package.pkg/layers
This is done in genmake2
ENABLE -layers
edit LAYERS_SIZE.h at compile time to set the  
number of layers (Nlayers) you want to calculate.

LAYER_SIZE.h - set up as follows


C  - Just as you have to define Nr in SIZE.h, you must define the number
C    of vertical layers for isopycnal averaging so that the proper array
C    sizes can be declared in the LAYERS.h header file.
C
C  - Variables -
C      NLayers        :: the number of isopycnal layers (must match data.layers)
C      FineGridFact   :: how many fine-grid cells per dF cell
C      FineGridMax    :: the number of points in the finer vertical grid
C                        used for interpolation
C      layers_maxNum  :: max number of tracer fields used for layer averaging
      INTEGER    Nlayers, FineGridFact, FineGridMax, layers_maxNum
      PARAMETER( Nlayers = 20 )
      PARAMETER( FineGridFact = 10 )
      PARAMETER( FineGridMax = Nr * FineGridFact )
      PARAMETER( layers_maxNum = 1 )

check outputs code/packages.conf
should output the streamfunction!

Must turn on in data.pkg
useLayers=.TRUE.,

Then you need to have a data.layers. Here is the one I use:
&LAYERS_PARM01
  # 20 year averaging
  layers_taveFreq=1261440000.0,
  # no instantaneous output
  layers_diagFreq=0.,
  layers_G=-0.2,0.0,0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6,1.8,2.0,
  2.2,2.4,2.6,2.8,3.0,3.2,3.4,3.6,3.8,4.0,
  4.2,4.4,4.6,4.8,5.0,5.2,5.4,5.6,5.8,6.0,
  6.2,6.4,6.6,6.8,7.0,7.2,7.4,7.6,7.8,8.0,8.2,
&

The length of layers_G should be Nlayers+1, because layers_G specifies
the *boundaries* of the layers, in whatever coordinate you use. By
default, it uses theta as the coordinate for the layers. But you can
change this to salt by setting LAYER_nb in data.layers. LAYER_nb=2
means salt, and LAYER_nb=3 means potential density, referenced to the
model level specified by layers_kref.


should try 5 year averaging

Talk to Adam or George Nurser.

Will need to rebuild using LAYERS_SIZE.h set to the correct values!
 
Should be able to work from pick up files still but just incase new build dir and executable with symbolic link

*****Things to think about******

What is the reference density - for a linear equation of stat it is 999.8.... what equation of state am I using? The default is set as a linear equation of state

Is the finegrid just simply diving up the 24 layers into finer layers?

So I think:

rebuild an mitgcmuv.psi

edit LAYER_SIZE.h in code dir and copy into build

LAYER_SIZE.h - set up as follows


C  - Just as you have to define Nr in SIZE.h, you must define the number
C    of vertical layers for isopycnal averaging so that the proper array
C    sizes can be declared in the LAYERS.h header file.
C
C  - Variables -
C      NLayers        :: the number of isopycnal layers (must match data.layers)
C      FineGridFact   :: how many fine-grid cells per dF cell
C      FineGridMax    :: the number of points in the finer vertical grid
C                        used for interpolation
C      layers_maxNum  :: max number of tracer fields used for layer averaging
      INTEGER    Nlayers, FineGridFact, FineGridMax, layers_maxNum
      PARAMETER( Nlayers = 80 )
      PARAMETER( FineGridFact = 20 )
      PARAMETER( FineGridMax = Nr * FineGridFact )
      PARAMETER( layers_maxNum = 1 )

Copy through into fibre/MITgcm/nchannel

set up a symbolic link to new executable keeping old one! 

Must turn on in data.pkg
useLayers=.TRUE.,

Then you need to have a data.layers. Here is the one I use:
&LAYERS_PARM01
  # 5 year averaging
  layers_taveFreq=345600.0,
  # no instantaneous output
 #LAYER_nb=3 sets layers to be in potential density
  LAYER_nb=3
  layers_diagFreq=0.,
  layers_G=23,23.1,23.2,23.3,23.4,23.5,23.6,23.7,23.8,23.9,24,24.1,24.2,24.3,24.4,24.5,24.6,24.7,24.8,24.9,25,25.1,25.2,25.3,25.4,25.5,25.6,25.7,25.8,25.9,26,26.1,26.2,26.3,26.4,26.5,26.6,26.7,26.8,26.9,27,27.1,27.2,27.3,27.4,27.5,27.6,27.7,27.8,27.9,28
  &

(go onto matlab and create an array 81,1 between 24 and 28)

Then it should be good to go from next set of pick up files!

This will not output into MNC format so you will have to use the python scripts to deal with the 
MDISO format that will be output! 



Offline:
This should be done at least on the past runs
use the MITgcm compute_density.m to compute density

